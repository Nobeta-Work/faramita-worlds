# 修复世界卡显示异常与数据库访问权限方案

当前控制台报错 `Cannot read properties of undefined (reading 'public_visible')` 以及终端中的 `Unable to move the cache: 拒绝访问` 指向了两个核心问题：代码健壮性不足以及本地存储（IndexedDB/Cache）访问受限。

## 1. 核心修复步骤

### 增强代码健壮性 (EntityViewer.vue)
*   **问题**：部分世界卡条目（如设定卡）可能缺失 `visible` 属性，导致前端过滤逻辑崩溃。
*   **对策**：在 [EntityViewer.vue](file:///d:/Education/Project/Faramita%20Worlds/src/renderer/components/EntityViewer.vue) 的 `visibleCards` 计算属性中增加可选链 (`?.`) 或判空逻辑。

### 优化数据导入逻辑 (importer.ts)
*   **问题**：如果数据库已存在但数据结构不完整，目前的 `importInitialData` 会跳过导入。
*   **对策**：改进 [importer.ts](file:///d:/Education/Project/Faramita%20Worlds/src/renderer/db/importer.ts)，确保导入时为缺失 `visible` 字段的卡片补全默认值。

### 解决数据库访问权限 (Terminal Error)
*   **问题**：终端报错 `拒绝访问 (0x5)` 表示 Electron 无法写入本地缓存目录。这通常是因为：
    1.  **进程残留**：旧的 Electron 实例未完全关闭，锁定了数据库文件。
    2.  **权限受限**：系统权限或杀毒软件阻止了 `AppData` 目录的写入。
*   **对策**：
    1.  建议用户在任务管理器中彻底结束所有 `Electron` 进程。
    2.  在 [db.ts](file:///d:/Education/Project/Faramita%20Worlds/src/renderer/db/db.ts) 中增加数据库开启失败的捕获与提示。

## 2. 具体操作计划

1.  **修复前端崩溃**：修改 [EntityViewer.vue](file:///d:/Education/Project/Faramita%20Worlds/src/renderer/components/EntityViewer.vue) 第 11 行，改为：
    `worldStore.cards.filter(c => c.visible?.public_visible || c.visible?.player_visible)`。
2.  **补全数据模板**：确保 [Oort.json](file:///d:/Education/Project/Faramita%20Worlds/src/world_template/Oort.json) 中的所有条目均包含 `visible` 结构。
3.  **增加数据库诊断**：在 [main.ts](file:///d:/Education/Project/Faramita%20Worlds/src/renderer/main.ts) 中捕获导入异常并打印更详细的错误。

**确认后，我将立即执行代码修复并协助您恢复数据环境。**